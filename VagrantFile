require 'yaml'

condement_config = YAML.load_file('./condement.yaml')

Vagrant.configure(2) do |config|
    config.vm.define "Condement" do |server|
        server.vm.box = "ubuntu/bionic64"
        server.vm.hostname = condement_config['hostname']

        server.vm.provider :virtualbox do |v|
            # Configure basic VM settings
            v.name = condement_config['hostname']
            v.gui = condement_config['show_gui']

            # Configure resources available to the VM
            v.cpus = condement_config['cpus']
            v.memory = condement_config['memory_mb']

            # Configure clipboard and drag and drop for ease of use
            v.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
            v.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]

            # Configure the display
            accelerate3d = 'off'
            if (condement_config['video_3d_acceleration']) then
                accelerate3d = 'on'
            end

            v.customize ['modifyvm', :id, '--accelerate3d', accelerate3d]
            v.customize ['modifyvm', :id, '--vram', condement_config['video_memory_mb']]
        end

        # Update the system
        config.vm.provision "shell", inline: "sudo apt update"
        config.vm.provision "shell", inline: "sudo apt upgrade -y"

        # Install puppet
        config.vm.provision "shell", inline: "sudo apt install -y puppet"

        # Run puppet base
        config.vm.provision 'puppet' do |puppet|
            puppet.manifests_path = "puppet_base"
            puppet.manifest_file = "base.pp"
        end

        # Set the keyboard language
        config.vm.provision "shell", inline: "sudo chmod 777 /etc/default/keyboard" # Change permissions so that file copy works
        config.vm.provision 'file', source: "./keyboard_layouts/" + condement_config['keyboard_layout'], destination: '/etc/default/keyboard'

        # Install the desktop
        if (condement_config['desktop'] && condement_config['desktop'] != 'none') then
            config.vm.provision 'puppet' do |puppet|
                puppet.manifests_path = "desktops"
                puppet.manifest_file = condement_config['desktop'] + ".pp"
            end
        end

        # Run the puppet files identified in the configuration for install
        puppet_files_to_apply = condement_config['software']
        puppet_files_to_apply.each do |puppet_file|
            config.vm.provision 'puppet' do |puppet|
                puppet.manifests_path = 'software'
                puppet.manifest_file = puppet_file + '.pp'
            end
        end

        # Configure the work folder
        server.vm.synced_folder condement_config['host_work_dir'], "/mnt/work/"

        # Restart the VM
        config.vm.provision "shell", inline: "reboot"
    end
end
